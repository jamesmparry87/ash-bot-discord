# pyright: reportUndefinedVariable=false
name: Develop Branch Tests

on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    # Service containers for testing
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test_discord_bot
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: 3.11
    
    - name: Cache pip packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt', '**/requirements-test.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python3 -m pip install --upgrade pip
        pip3 install -r Live/requirements.txt
        pip3 install -r Live/tests/requirements-test.txt
    
    - name: Set up test environment variables
      env:
        DISCORD_TOKEN: ${{ secrets.TEST_DISCORD_TOKEN }}
        DATABASE_URL: postgresql://test:test@localhost:5432/test_discord_bot
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        TWITCH_CLIENT_ID: ${{ secrets.TWITCH_CLIENT_ID }} 
        TWITCH_CLIENT_SECRET: ${{ secrets.TWITCH_CLIENT_SECRET }}
        # Test-specific environment variables
        TEST_MODE: true
        GUILD_ID: "123456789"
        VIOLATION_CHANNEL_ID: "123456790"
        MOD_ALERT_CHANNEL_ID: "123456791"
        TWITCH_HISTORY_CHANNEL_ID: "123456792"
        YOUTUBE_HISTORY_CHANNEL_ID: "123456793"
      run: |
        echo "Environment variables set for testing"
    
    - name: Wait for PostgreSQL to be ready
      run: |
        until pg_isready -h localhost -p 5432 -U test; do
          echo "Waiting for PostgreSQL..."
          sleep 2
        done
        echo "PostgreSQL is ready!"
    
    - name: Run database tests
      env:
        DATABASE_URL: postgresql://test:test@localhost:5432/test_discord_bot
      run: |
        python3 -m pytest Live/tests/test_database.py -v --tb=short --durations=10
    
    - name: Run command tests
      env:
        DATABASE_URL: postgresql://test:test@localhost:5432/test_discord_bot
        DISCORD_TOKEN: ${{ secrets.TEST_DISCORD_TOKEN }}  # pyright: ignore
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}  # pyright: ignore
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}  # pyright: ignore
      run: |
        python3 -m pytest Live/tests/test_commands.py -v --tb=short --durations=10
    
    - name: Run AI integration tests
      env:
        DATABASE_URL: postgresql://test:test@localhost:5432/test_discord_bot
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}  # pyright: ignore
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}  # pyright: ignore
      run: |
        python3 -m pytest Live/tests/test_ai_integration.py -v --tb=short --durations=10
    
    - name: Run all tests with coverage
      env:
        DATABASE_URL: postgresql://test:test@localhost:5432/test_discord_bot
        DISCORD_TOKEN: ${{ secrets.TEST_DISCORD_TOKEN }}  # pyright: ignore*
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}  # pyright: ignore
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}  # pyright: ignore
        YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}  # pyright: ignore
        TWITCH_CLIENT_ID: ${{ secrets.TWITCH_CLIENT_ID }}  # pyright: ignore
        TWITCH_CLIENT_SECRET: ${{ secrets.TWITCH_CLIENT_SECRET }}  # pyright: ignore
        TEST_MODE: true
        GUILD_ID: "123456789"
        VIOLATION_CHANNEL_ID: "123456790"
        MOD_ALERT_CHANNEL_ID: "123456791"
        TWITCH_HISTORY_CHANNEL_ID: "123456792"
        YOUTUBE_HISTORY_CHANNEL_ID: "123456793"
        PYTHONPATH: Live
      run: |
        python3 -m pytest Live/tests/ -v --cov=Live --cov-report=term-missing --cov-report=xml --tb=short
    
    - name: Upload coverage to GitHub
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage.xml
    
    - name: Validate bot can start (smoke test)
      env:
        DATABASE_URL: postgresql://test:test@localhost:5432/test_discord_bot
        DISCORD_TOKEN: ${{ secrets.TEST_DISCORD_TOKEN }}  # pyright: ignore
        TEST_MODE: true
      run: |
        cd Live
        timeout 30s python3 -c "
        import ash_bot_fallback
        print('Bot imports successfully')
        db = ash_bot_fallback.db
        if db.database_url:
            print('Database connection configured')
        else:
            print('Database connection not configured')
        print('Smoke test passed')
        " || echo "Smoke test completed (timeout expected)"

  lint:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Allow pushing auto-fix commits back to the repository
      pull-requests: write  # Allow updating PRs
      repository-projects: read  # Allow reading repository metadata
    
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0  # Fetch all history for proper branch operations
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: 3.11
    
    - name: Install linting dependencies
      run: |
        python3 -m pip install --upgrade pip
        pip3 install flake8 black isort mypy autopep8
        pip3 install -r Live/requirements.txt
    
    - name: Run Black code formatting check (non-blocking)
      run: |
        black --check --diff Live/ --exclude Live/tests/ || echo "‚ö†Ô∏è  Black formatting issues detected (non-blocking) - consider running 'black Live/ --exclude Live/tests/' locally"
    
    - name: Auto-fix import sorting with isort
      run: |
        # Configure git for automated commits
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        
        # Debug: Show current git state
        echo "Current git branch: $(git branch --show-current)"
        echo "GITHUB_HEAD_REF: $GITHUB_HEAD_REF"
        echo "GITHUB_REF: $GITHUB_REF"
        
        # Determine branch name and ensure we're on it
        if [ -n "$GITHUB_HEAD_REF" ]; then
          BRANCH_NAME="$GITHUB_HEAD_REF"
        else
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
        fi
        
        echo "Target branch: $BRANCH_NAME"
        
        # Create and checkout the branch if it doesn't exist locally
        if ! git show-ref --verify --quiet refs/heads/$BRANCH_NAME; then
          echo "Branch $BRANCH_NAME doesn't exist locally, creating it..."
          git checkout -b $BRANCH_NAME
        else
          echo "Checking out existing branch $BRANCH_NAME..."
          git checkout $BRANCH_NAME
        fi
        
        # Run isort to fix import order (without --check-only)
        echo "üîß Running isort to auto-fix import ordering..."
        isort Live/ --skip Live/tests/
        
        # Check if there are any changes to commit
        if git diff --quiet; then
          echo "‚úÖ No import sorting changes needed"
        else
          echo "üìù Import sorting changes detected, committing..."
          git add Live/
          git commit -m "chore: auto-fix import sorting with isort [skip ci]"
          
          # Push the changes back to the branch
          git push origin $BRANCH_NAME
          echo "‚úÖ Import sorting fixes committed and pushed"
        fi
    
    - name: Auto-fix PEP 8 violations with autopep8
      run: |
        # Determine branch name and ensure we're on it
        if [ -n "$GITHUB_HEAD_REF" ]; then
          BRANCH_NAME="$GITHUB_HEAD_REF"
        else
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
        fi
        
        echo "Target branch for autopep8: $BRANCH_NAME"
        
        # Create and checkout the branch if it doesn't exist locally
        if ! git show-ref --verify --quiet refs/heads/$BRANCH_NAME; then
          echo "Branch $BRANCH_NAME doesn't exist locally, creating it..."
          git checkout -b $BRANCH_NAME
        else
          echo "Checking out existing branch $BRANCH_NAME..."
          git checkout $BRANCH_NAME
        fi
        
        # Run autopep8 to fix common PEP 8 violations automatically
        echo "üîß Running autopep8 to auto-fix PEP 8 violations..."
        autopep8 --in-place --aggressive --aggressive --recursive Live/ --exclude Live/tests/
        
        # Check if there are any changes to commit
        if git diff --quiet; then
          echo "‚úÖ No PEP 8 auto-fixes needed"
        else
          echo "üìù PEP 8 auto-fixes applied, committing..."
          git add Live/
          git commit -m "chore: auto-fix PEP 8 violations with autopep8 [skip ci]"
          
          # Push the changes back to the branch
          git push origin $BRANCH_NAME
          echo "‚úÖ PEP 8 auto-fixes committed and pushed"
        fi
        
        # Run flake8 for remaining issues (non-blocking)
        echo "üîç Running flake8 for code quality review..."
        flake8 Live/ --exclude=Live/tests/ || echo "‚ö†Ô∏è  Flake8 found remaining style issues (non-blocking) - review recommended"
    
    - name: Run mypy type checking
      run: |
        mypy Live/database.py --ignore-missing-imports || echo "Type checking completed with issues (non-blocking)"

  security:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: 3.11
    
    - name: Install security tools
      run: |
        python3 -m pip install --upgrade pip
        pip3 install bandit safety
    
    - name: Run Bandit security linting
      run: |
        bandit -r Live/ -f json -o bandit-report.json || echo "Bandit scan completed"
    
    - name: Check for known security vulnerabilities
      run: |
        pip3 install -r Live/requirements.txt
        safety check --json --output safety-report.json || echo "Safety check completed"
    
    - name: Check for hardcoded API credentials (BLOCKING)
      run: |
        echo "üîç Scanning for hardcoded API credentials..."
        echo "This check prevents accidental commits of real API keys, tokens, and secrets."
        echo ""
        
        # Search for variables with API/TOKEN/KEY/SECRET/PASSWORD that have alphanumeric values
        # Pattern: Matches assignments with 20+ character alphanumeric strings
        # Excludes: test files, mocks, placeholders, env var references
        
        VIOLATIONS=$(grep -r -n \
          -E '(API|TOKEN|KEY|SECRET|PASSWORD)[_A-Z0-9]*\s*=\s*["'"'"'][A-Za-z0-9_\-]{20,}["'"'"']' \
          --include="*.py" \
          --exclude-dir="tests" \
          --exclude-dir=".git" \
          --exclude-dir="__pycache__" \
          --exclude-dir="venv" \
          --exclude-dir="node_modules" \
          Live/ | \
          grep -v "test_" | \
          grep -v "mock_" | \
          grep -v "your-.*-here" | \
          grep -v "example" | \
          grep -v "placeholder" | \
          grep -v "os.getenv" | \
          grep -v "os.environ" | \
          grep -v "TEST_" | \
          grep -v "FAKE_" | \
          grep -v "DUMMY_" | \
          grep -v "xxx" | \
          grep -v "123" || true)
        
        if [ -n "$VIOLATIONS" ]; then
          echo "‚ùå SECURITY VIOLATION: Hardcoded credentials detected!"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          echo "$VIOLATIONS"
          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          echo "‚ö†Ô∏è  Found API credentials or secrets hardcoded in source files."
          echo ""
          echo "üîí Security Best Practices:"
          echo "   ‚Ä¢ Use environment variables: os.getenv('API_KEY')"
          echo "   ‚Ä¢ Use GitHub secrets in workflows"
          echo "   ‚Ä¢ Store credentials in .env files (git ignored)"
          echo "   ‚Ä¢ Never commit real API keys to version control"
          echo ""
          echo "‚ùå This is a BLOCKING error - merge is prevented until resolved."
          exit 1
        else
          echo "‚úÖ No hardcoded credentials detected"
          echo "   All API keys and secrets appear to be properly externalized."
        fi
    
    - name: Upload security reports
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json

  deployment-readiness:
    runs-on: ubuntu-latest
    needs: [test, lint]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Check Railway configuration
      run: |
        if [ -f "Live/railway.toml" ]; then
          echo "‚úÖ Railway configuration found"
          cat Live/railway.toml
        else
          echo "‚ùå Railway configuration missing"
          exit 1
        fi
    
    - name: Check required files
      run: |
        required_files=(
          "Live/requirements.txt"
          "Live/bot_modular.py"
          "Live/bot/database_module.py"
          "Live/bot/config.py"
          "Live/Procfile"
        )
        
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "‚úÖ $file found"
          else
            echo "‚ùå $file missing"
            exit 1
          fi
        done
    
    - name: Validate environment variables template
      run: |
        if [ -f "Live/.env.example" ]; then
          echo "‚úÖ Environment variables template found"
          echo "Required environment variables:"
          grep -E "^[A-Z_]+=" Live/.env.example || echo "No variables found in template"
        else
          echo "‚ùå .env.example missing"
          exit 1
        fi
    
    - name: Test summary
      run: |
        echo "üéØ **Deployment Readiness Check**"
        echo "‚úÖ All tests passed"
        echo "‚úÖ Code quality checks passed"
        echo "‚úÖ Required files present"
        echo "‚úÖ Configuration validated"
        echo ""
        echo "üìã **Ready for deployment to staging environment**"

  notify:
    runs-on: ubuntu-latest
    needs: [test, lint, security, deployment-readiness]
    if: always()
    
    steps:
    - name: Test Results Summary
      run: |
        echo "ü§ñ **Ash Bot - Develop Branch Test Results**"
        echo ""
        echo "**Test Status:** ${{ needs.test.result }}"
        echo "**Lint Status:** ${{ needs.lint.result }}"
        echo "**Security Status:** ${{ needs.security.result }}"
        echo "**Deployment Status:** ${{ needs.deployment-readiness.result }}"
        echo ""
        if [ "${{ needs.test.result }}" == "success" ] && [ "${{ needs.lint.result }}" == "success" ]; then
          echo "‚úÖ **All checks passed - Ready for staging deployment**"
        else
          echo "‚ùå **Some checks failed - Review required before deployment**"
        fi
